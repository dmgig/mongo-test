#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use Cli\Commands\CreateSourceCommand;
use Cli\Commands\ExtractContentCommand;
use Cli\Commands\ListAiModelsCommand;
use Cli\Commands\SourceBreakdownCommand;
use App\Domain\Source\SourceService;
use App\Domain\Content\AiContentExtractor;
use App\Domain\Content\ReadabilityContentExtractor;
use App\Domain\Content\ChunkingService;
use App\Infrastructure\Mongo\MongoConnector;
use App\Infrastructure\Mongo\MongoSourceRepository;
use App\Infrastructure\Mongo\MongoBreakdownRepository;
use App\Infrastructure\Mongo\MongoEventRepository;
use App\Infrastructure\Mongo\MongoPartyRepository;
use App\Infrastructure\Html\HtmlStructureService;
use App\Infrastructure\Ai\Gemini\GeminiAdapter;
use App\Domain\Event\EmbeddingService;
use App\Domain\Party\PartyService;
use App\Domain\Party\PartyRelationshipRepositoryInterface;
use Symfony\Component\Console\Application;
use Dotenv\Dotenv;

// Load Environment Variables
$dotenv = Dotenv::createImmutable(__DIR__ . '/..');
$dotenv->load();

$application = new Application();

// Manual Dependency Injection
$connector = MongoConnector::fromEnvironment();
$sourceRepo = new MongoSourceRepository($connector);
$sourceService = new SourceService($sourceRepo);
$breakdownRepo = new MongoBreakdownRepository($connector);
$eventRepo = new MongoEventRepository($connector);
$partyRepo = new MongoPartyRepository($connector);
$partyRelationshipRepo = new \App\Infrastructure\Mongo\MongoPartyRelationshipRepository($connector);

// AI Setup
$apiKey = $_ENV["GEMINI_API_KEY"] ?? getenv("GEMINI_API_KEY");
if (!$apiKey) {
    echo "Warning: GEMINI_API_KEY not set in " . __DIR__ . "/../.env\n";
    $apiKey = "dummy";
}
$geminiClient = Gemini::client($apiKey);
$aiAdapter = new GeminiAdapter($geminiClient);

// Services
$htmlStructureService = new HtmlStructureService();
$aiExtractor = new AiContentExtractor($htmlStructureService, $aiAdapter);
$readabilityExtractor = new ReadabilityContentExtractor();
$chunkingService = new ChunkingService();
$embeddingService = new EmbeddingService($aiAdapter);
$partyService = new PartyService($partyRepo, $partyRelationshipRepo);

$extractors = [
    "ai" => $aiExtractor,
    "readability" => $readabilityExtractor,
];

// Register Commands
$application->add(new CreateSourceCommand($sourceService));
$application->add(new ExtractContentCommand($sourceService, $extractors));
$application->add(new ListAiModelsCommand($geminiClient));
$application->add(new SourceBreakdownCommand($sourceService, $readabilityExtractor, $aiAdapter, $breakdownRepo, $eventRepo, $chunkingService, $embeddingService, $partyService));

$application->run();
